name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type. Auto reads commit messages (feat:=minor, fix:=patch, BREAKING CHANGE=major).'
        required: false
        type: choice
        default: auto
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Determine version bump
        id: bump
        shell: bash
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          # Find the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${LAST_TAG}..HEAD"
          fi
          echo "range=$RANGE" >> $GITHUB_OUTPUT
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          BUMP="${{ github.event.inputs.bump }}"
          if [ "$BUMP" = "auto" ] || [ -z "$BUMP" ]; then
            # Read commits since last tag to determine bump type
            COMMITS=$(git log $RANGE --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

            if echo "$COMMITS" | grep -qiE "^.*BREAKING CHANGE|^.*!:"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "^feat"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi
          echo "type=$BUMP" >> $GITHUB_OUTPUT

          # Calculate new version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case "$BUMP" in
            major) NEW="$((MAJOR+1)).0.0" ;;
            minor) NEW="${MAJOR}.$((MINOR+1)).0" ;;
            patch) NEW="${MAJOR}.${MINOR}.$((PATCH+1))" ;;
          esac
          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "Bump: $BUMP | $CURRENT -> $NEW"

      - name: Generate release notes
        id: notes
        shell: bash
        run: |
          RANGE="${{ steps.bump.outputs.range }}"
          LAST_TAG="${{ steps.bump.outputs.last_tag }}"
          NEW="${{ steps.bump.outputs.new }}"

          {
            echo "body<<RELEASE_EOF"
            echo "## What's Changed"
            echo ""

            # Features
            FEATS=$(git log $RANGE --pretty=format:"- %s" --grep="^feat" -i 2>/dev/null || true)
            if [ -n "$FEATS" ]; then
              echo "### New Features"
              echo "$FEATS" | sed 's/^- feat[:(]/- /' | sed 's/^- /- /'
              echo ""
            fi

            # Fixes
            FIXES=$(git log $RANGE --pretty=format:"- %s" --grep="^fix" -i 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES" | sed 's/^- fix[:(]/- /' | sed 's/^- /- /'
              echo ""
            fi

            # CI/Chore/Other
            OTHERS=$(git log $RANGE --pretty=format:"- %s" 2>/dev/null | grep -viE "^- (feat|fix)" || true)
            if [ -n "$OTHERS" ]; then
              echo "### Other Changes"
              echo "$OTHERS"
              echo ""
            fi

            if [ -n "$LAST_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${NEW}"
            fi
            echo "RELEASE_EOF"
          } >> $GITHUB_OUTPUT

      - name: Bump version in package.json
        shell: bash
        run: |
          NEW="${{ steps.bump.outputs.new }}"
          node -e "
            const pkg = require('./package.json');
            pkg.version = '$NEW';
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Build Electron (Windows)
        run: npx electron-builder --win --config .electron-builder.config.js

      - name: Commit version bump
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new }}"
          git push

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.new }}
          name: SoundPad Pro v${{ steps.bump.outputs.new }}
          body: ${{ steps.notes.outputs.body }}
          draft: false
          files: |
            dist/SoundPad-Pro-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
